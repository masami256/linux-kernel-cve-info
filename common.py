import sqlite3

CVE_DATABASE_NAME = "nvd_cve_db.db"

def connect():
    conn = sqlite3.connect(CVE_DATABASE_NAME)
    if not conn:
        print(f"Failed to open {CVE_DATABASE_NAME}")
        exit(1)

    return conn

def count_cves_by_years(conn, yaers):
    data = {}

    for year in yaers:
        sql = f"select count(*) from nvd where strftime('%Y', published) = '{year}'"
        c = conn.cursor()
        c.execute(sql)
        count = c.fetchone()
        data[year] = count[0]

        c.close()

    return data

def get_published_dates(conn):
    years = []

    sql = "select distinct strftime('%Y', published) as year from nvd"

    c = conn.cursor()
    c.execute(sql)

    results = c.fetchall()
    for row in results:
        years.append(row[0])

    c.close()

    return years

def get_nvd_cve_data_by_year(conn):
    years = get_published_dates(conn)
    data = {}

    for year in years:
        sql = f"select id from nvd where strftime('%Y', published) = '{year}'"
        c = conn.cursor()
        c.execute(sql)

        results = c.fetchall()
        for row in results:
            if not year in data:
                data[year] = [row[0]]
            else:
                data[year].append(row[0])

        c.close()
    
    return data
